<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>SpringBoot 的客制化 | 墨坊のBlog</title><meta name="description" content="基于 Spring Boot 的客制化 错误处理机制及 servlet 容器"><meta name="keywords" content="SpringBoot"><meta name="author" content="mofang-sudo,outcome1998@gmail.com"><meta name="copyright" content="mofang-sudo"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2020/10/28/SpringBoot-%E7%9A%84%E5%AE%A2%E5%88%B6%E5%8C%96/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="SpringBoot 的客制化"><meta property="og:url" content="http://example.com/2020/10/28/SpringBoot-%E7%9A%84%E5%AE%A2%E5%88%B6%E5%8C%96/"><meta property="og:site_name" content="墨坊のBlog"><meta property="og:description" content="基于 Spring Boot 的客制化 错误处理机制及 servlet 容器"><meta property="og:image" content="http://example.com/images/post/preview22.jpg"><meta property="article:published_time" content="2020-10-28T00:52:20.000Z"><meta property="article:modified_time" content="2020-10-29T08:56:37.973Z"><meta name="twitter:card" content="summary"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.1.1',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime: '天',
  date_suffix: {"one_hour":"刚刚","hours":"小时前","day":"天前"},
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: true
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
    },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-10-29 16:56:37'
}</script><noscript><style type="text/css">
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
  }
}

var autoChangeMode = 'false'
var t = saveToLocal.get('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (saveToLocal.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/self/Kimbiedark.css"><meta name="generator" content="Hexo 5.1.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avater.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">26</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">17</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">14</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6"><span class="toc-number">1.</span> <span class="toc-text">错误处理机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Boot-%E7%9A%84%E9%BB%98%E8%AE%A4%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6"><span class="toc-number">1.1.</span> <span class="toc-text">Spring Boot 的默认错误处理机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2"><span class="toc-number">1.2.</span> <span class="toc-text">定制错误页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6%E9%94%99%E8%AF%AF%E7%9A%84-json-%E6%95%B0%E6%8D%AE"><span class="toc-number">1.3.</span> <span class="toc-text">定制错误的 json 数据</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%9A%84-Servlet-%E5%AE%B9%E5%99%A8"><span class="toc-number">2.</span> <span class="toc-text">配置嵌入式的 Servlet 容器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6-amp-%E4%BF%AE%E6%94%B9-Servlet-%E5%AE%B9%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">定制&amp;修改 Servlet 容器配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C-Servlet-%E5%AE%B9%E5%99%A8%E7%9A%84%E4%B8%89%E5%A4%A7%E7%BB%84%E4%BB%B6"><span class="toc-number">2.2.</span> <span class="toc-text">注册 Servlet 容器的三大组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Boot-%E6%94%AF%E6%8C%81%E7%9A%84-Servlet-%E5%AE%B9%E5%99%A8"><span class="toc-number">2.3.</span> <span class="toc-text">Spring Boot 支持的 Servlet 容器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B5%8C%E5%85%A5%E5%BC%8F-Servlet-%E5%AE%B9%E5%99%A8%E7%9A%84%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%8E%9F%E7%90%86"><span class="toc-number">2.4.</span> <span class="toc-text">嵌入式 Servlet 容器的自动配置原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B5%8C%E5%85%A5%E5%BC%8F-Servlet-%E5%AE%B9%E5%99%A8%E7%9A%84%E5%90%AF%E5%8A%A8%E5%8E%9F%E7%90%86"><span class="toc-number">2.5.</span> <span class="toc-text">嵌入式 Servlet 容器的启动原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%A4%96%E7%BD%AE%E7%9A%84-Servlet-%E5%AE%B9%E5%99%A8"><span class="toc-number">2.6.</span> <span class="toc-text">使用外置的 Servlet 容器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%96%E7%BD%AE-Servlet-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E7%94%A8-Spring-Boot-%E5%BA%94%E7%94%A8%E5%8E%9F%E7%90%86"><span class="toc-number">2.7.</span> <span class="toc-text">外置 Servlet 服务器启用 Spring Boot 应用原理</span></a></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(/images/post/preview22.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">墨坊のBlog</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">SpringBoot 的客制化</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-10-28T00:52:20.000Z" title="发表于 2020-10-28 08:52:20">2020-10-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-10-29T08:56:37.973Z" title="更新于 2020-10-29 16:56:37">2020-10-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/">Java</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/SpringBoot%E6%A1%86%E6%9E%B6/">SpringBoot框架</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="错误处理机制"><a href="#错误处理机制" class="headerlink" title="错误处理机制"></a>错误处理机制</h1><h2 id="Spring-Boot-的默认错误处理机制"><a href="#Spring-Boot-的默认错误处理机制" class="headerlink" title="Spring Boot 的默认错误处理机制"></a>Spring Boot 的默认错误处理机制</h2><blockquote>
<p>Spring Boot 的默认错误页面</p>
</blockquote>
<p> <img src="/images/post/springboot/Snipaste_09.png"></p>
<blockquote>
<p>其他客户端访问，默认响应 json 数据</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">&quot;timestamp&quot;</span>: <span class="hljs-string">&quot;2020-10-27T11:35:57.047+00:00&quot;</span>,<br>    <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-number">404</span>,<br>    <span class="hljs-attr">&quot;error&quot;</span>: <span class="hljs-string">&quot;Not Found&quot;</span>,<br>    <span class="hljs-attr">&quot;message&quot;</span>: <span class="hljs-string">&quot;No message available&quot;</span>,<br>    <span class="hljs-attr">&quot;path&quot;</span>: <span class="hljs-string">&quot;/crud/aaa&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="定制错误页面"><a href="#定制错误页面" class="headerlink" title="定制错误页面"></a>定制错误页面</h2><blockquote>
<p>执行原理，参照 errorMvcAutoConfiguration 错误处理自动配置</p>
</blockquote>
<p>几个重要组件：</p>
<ul>
<li><p><b style="color:mediumorchid">DefaultErrorAttributes：</b>默认异常属性</p>
<div class="note info"><p>实现在页面共享信息</p>
</div>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@ConditionalOnMissingBean(</span><br><span class="hljs-meta">    value = &#123;ErrorAttributes.class&#125;,</span><br><span class="hljs-meta">    search = SearchStrategy.CURRENT</span><br><span class="hljs-meta">)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> DefaultErrorAttributes <span class="hljs-title">errorAttributes</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultErrorAttributes();<br>&#125;<br><br><span class="hljs-comment">//DefaultErrorAttributes</span><br><span class="hljs-meta">@Order(-2147483648)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultErrorAttributes</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ErrorAttributes</span>, <span class="hljs-title">HandlerExceptionResolver</span>, <span class="hljs-title">Ordered</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String ERROR_ATTRIBUTE = DefaultErrorAttributes.class.getName() + <span class="hljs-string">&quot;.ERROR&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Boolean includeException;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DefaultErrorAttributes</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.includeException = <span class="hljs-keyword">null</span>;<br>    &#125;<br><span class="hljs-comment">//可获取的信息</span><br>    timestamp : 时间戳; status : 状态码; exception : 异常类型; message : 异常信息; error : 错误提示; errors : JSR-<span class="hljs-number">303</span>数据校验的异常信息<br></code></pre></td></tr></table></figure>
</li>
<li><p><b style="color:mediumorchid">BasicErrorController：</b>基本错误控制器</p>
<div class="note info"><p>区分浏览器和客户端，通过请求头的 accept 属性来区分。</p>
</div>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@ConditionalOnMissingBean(</span><br><span class="hljs-meta">    value = &#123;ErrorController.class&#125;,</span><br><span class="hljs-meta">    //searchStrategy : 搜索策略</span><br><span class="hljs-meta">    search = SearchStrategy.CURRENT</span><br><span class="hljs-meta">)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> BasicErrorController <span class="hljs-title">basicErrorController</span><span class="hljs-params">(ErrorAttributes errorAttributes, ObjectProvider&lt;ErrorViewResolver&gt; errorViewResolvers)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BasicErrorController(errorAttributes, <span class="hljs-keyword">this</span>.serverProperties.getError(), (List)errorViewResolvers.orderedStream().collect(Collectors.toList()));<br>&#125;<br><br><span class="hljs-comment">//BasicErrorController</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&#123;&quot;$&#123;server.error.path:$&#123;error.path:/error&#125;&#125;&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BasicErrorController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractErrorController</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ErrorProperties errorProperties;<br>    <br>	<span class="hljs-meta">@RequestMapping(</span><br><span class="hljs-meta">        produces = &#123;&quot;text/html&quot;&#125;//产生 Html 类型数据的</span><br><span class="hljs-meta">    )</span><span class="hljs-comment">//处理浏览器</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title">errorHtml</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;<br>        <span class="hljs-comment">//获取到 状态码及model数据</span><br>        HttpStatus status = <span class="hljs-keyword">this</span>.getStatus(request);<br>        <span class="hljs-comment">//model 数据通过 DefaultErrorAttributes 获取，调用当前对象的 getErrorAttributes 方法</span><br>        Map&lt;String, Object&gt; model = Collections.unmodifiableMap(<span class="hljs-keyword">this</span>.getErrorAttributes(request, <span class="hljs-keyword">this</span>.getErrorAttributeOptions(request, MediaType.TEXT_HTML)));<br>        response.setStatus(status.value());<br>        <span class="hljs-comment">//返回一个 modelAndView ，通过基本错误控制器的 resolveErrorView 方法创建</span><br>        ModelAndView modelAndView = <span class="hljs-keyword">this</span>.resolveErrorView(request, response, status, model);<br>        <span class="hljs-comment">//modelAndView 仍未空，返回 视图名为 error 的视图</span><br>        <span class="hljs-keyword">return</span> modelAndView != <span class="hljs-keyword">null</span> ? modelAndView : <span class="hljs-keyword">new</span> ModelAndView(<span class="hljs-string">&quot;error&quot;</span>, model);<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping</span><span class="hljs-comment">//处理其它客户端	产生 json 类型的数据</span><br>    <span class="hljs-keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; error(HttpServletRequest request) &#123;<br>        HttpStatus status = <span class="hljs-keyword">this</span>.getStatus(request);<br>        <span class="hljs-keyword">if</span> (status == HttpStatus.NO_CONTENT) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseEntity(status);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            Map&lt;String, Object&gt; body = <span class="hljs-keyword">this</span>.getErrorAttributes(request, <span class="hljs-keyword">this</span>.getErrorAttributeOptions(request, MediaType.ALL));<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseEntity(body, status);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//resolveErrorView</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> ModelAndView <span class="hljs-title">resolveErrorView</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, HttpStatus status, Map&lt;String, Object&gt; model)</span> </span>&#123;<br>       	<span class="hljs-comment">//获取所有的异常视图解析器的迭代器对象</span><br>    	Iterator var5 = <span class="hljs-keyword">this</span>.errorViewResolvers.iterator();<br><br>        ModelAndView modelAndView;<br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-keyword">if</span> (!var5.hasNext()) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>            &#125;<br><br>            ErrorViewResolver resolver = (ErrorViewResolver)var5.next();<br>            modelAndView = resolver.resolveErrorView(request, status, model);<br>        &#125; <span class="hljs-keyword">while</span>(modelAndView == <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-keyword">return</span> modelAndView;<br>    &#125;<br><br><span class="hljs-comment">//getErrorAttributes</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Map&lt;String, Object&gt; <span class="hljs-title">getErrorAttributes</span><span class="hljs-params">(HttpServletRequest request, ErrorAttributeOptions options)</span> </span>&#123;<br>        WebRequest webRequest = <span class="hljs-keyword">new</span> ServletWebRequest(request);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.errorAttributes.getErrorAttributes(webRequest, options);<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p><b style="color:mediumorchid">ErrorPageCostomizer：</b>错误页面定制器</p>
<div class="note info"><p>系统出现错误时会来到 error 请求进行处理，相当于原来的 web.xml 中的错误页面配置</p>
</div>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//errorPageCustomizer</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-comment">//返回一个静态内部类的对象</span><br><span class="hljs-keyword">public</span> ErrorMvcAutoConfiguration.<span class="hljs-function">ErrorPageCustomizer <span class="hljs-title">errorPageCustomizer</span><span class="hljs-params">(DispatcherServletPath dispatcherServletPath)</span> </span>&#123;<br>    <span class="hljs-comment">//通过构造器创建的对象 serverProperties 与 配置文件的 server 绑定，dispatcherServletPath ：上下文路径</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ErrorMvcAutoConfiguration.ErrorPageCustomizer(<span class="hljs-keyword">this</span>.serverProperties, dispatcherServletPath);<br>&#125;<br><br><span class="hljs-comment">//ErrorPageCustomizer</span><br><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ErrorPageCustomizer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ErrorPageRegistrar</span>, <span class="hljs-title">Ordered</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ServerProperties properties;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DispatcherServletPath dispatcherServletPath;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">ErrorPageCustomizer</span><span class="hljs-params">(ServerProperties properties, DispatcherServletPath dispatcherServletPath)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.properties = properties;<br>        <span class="hljs-keyword">this</span>.dispatcherServletPath = dispatcherServletPath;<br>    &#125;<br>	<span class="hljs-comment">//重要方法：注册错误页面</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerErrorPages</span><span class="hljs-params">(ErrorPageRegistry errorPageRegistry)</span> </span>&#123;<br>        <span class="hljs-comment">//创建错误页面对象，通过配置文件配置的路径的相对路径</span><br>        ErrorPage errorPage = <span class="hljs-keyword">new</span> ErrorPage(<span class="hljs-keyword">this</span>.dispatcherServletPath.getRelativePath(<span class="hljs-keyword">this</span>.properties.getError().getPath()));<br>        errorPageRegistry.addErrorPages(<span class="hljs-keyword">new</span> ErrorPage[]&#123;errorPage&#125;);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getOrder</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//getpath() </span><br><span class="hljs-meta">@Value(&quot;$&#123;error.path:/error&#125;&quot;)</span><br><span class="hljs-keyword">private</span> String path = <span class="hljs-string">&quot;/error&quot;</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPath</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.path;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p><b style="color:mediumorchid">DefaultErrorViewResolver：</b>默认的异常视图解析器</p>
<div class="note info"><p>errorViewName 以精确优先。</p>
</div>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//DefaultErrorViewResolver</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@ConditionalOnBean(&#123;DispatcherServlet.class&#125;)</span><br><span class="hljs-meta">@ConditionalOnMissingBean(&#123;ErrorViewResolver.class&#125;)</span><br><span class="hljs-function">DefaultErrorViewResolver <span class="hljs-title">conventionErrorViewResolver</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultErrorViewResolver(<span class="hljs-keyword">this</span>.applicationContext, <span class="hljs-keyword">this</span>.resourceProperties);<br>&#125;<br><br><span class="hljs-comment">//DefaultErrorViewResolver</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultErrorViewResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ErrorViewResolver</span>, <span class="hljs-title">Ordered</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;Series, String&gt; SERIES_VIEWS;<br>    <span class="hljs-keyword">private</span> ApplicationContext applicationContext;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResourceProperties resourceProperties;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TemplateAvailabilityProviders templateAvailabilityProviders;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> order = <span class="hljs-number">2147483647</span>;<br>    <br>    <span class="hljs-keyword">static</span> &#123;<br>        Map&lt;Series, String&gt; views = <span class="hljs-keyword">new</span> EnumMap(Series.class);<br>        <span class="hljs-comment">//也可统一命名为 4xx\5xx</span><br>        views.put(Series.CLIENT_ERROR, <span class="hljs-string">&quot;4xx&quot;</span>);<br>        views.put(Series.SERVER_ERROR, <span class="hljs-string">&quot;5xx&quot;</span>);<br>        SERIES_VIEWS = Collections.unmodifiableMap(views);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DefaultErrorViewResolver</span><span class="hljs-params">(ApplicationContext applicationContext, ResourceProperties resourceProperties)</span> </span>&#123;<br>        Assert.notNull(applicationContext, <span class="hljs-string">&quot;ApplicationContext must not be null&quot;</span>);<br>        Assert.notNull(resourceProperties, <span class="hljs-string">&quot;ResourceProperties must not be null&quot;</span>);<br>        <span class="hljs-keyword">this</span>.applicationContext = applicationContext;<br>        <span class="hljs-keyword">this</span>.resourceProperties = resourceProperties;<br>        <span class="hljs-keyword">this</span>.templateAvailabilityProviders = <span class="hljs-keyword">new</span> TemplateAvailabilityProviders(applicationContext);<br>    &#125;<br>    <br>    <span class="hljs-comment">//获取 modelAndView</span><br>     <span class="hljs-function"><span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title">resolveErrorView</span><span class="hljs-params">(HttpServletRequest request, HttpStatus status, Map&lt;String, Object&gt; model)</span> </span>&#123;<br>         <span class="hljs-comment">//调用 DefaultErrorViewResolver 的 resolver 方法</span><br>         <span class="hljs-comment">//status.value() : 视图名为当前异常的状态码</span><br>        ModelAndView modelAndView = <span class="hljs-keyword">this</span>.resolve(String.valueOf(status.value()), model);<br>        <span class="hljs-keyword">if</span> (modelAndView == <span class="hljs-keyword">null</span> &amp;&amp; SERIES_VIEWS.containsKey(status.series())) &#123;<br>            <span class="hljs-comment">//没有模板解析，并且也找不到对应的异常页面。就使用 error/status.html</span><br>            modelAndView = <span class="hljs-keyword">this</span>.resolve((String)SERIES_VIEWS.get(status.series()), model);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> modelAndView;<br>    &#125;<br><br>    <span class="hljs-comment">//resolver 方法需要传入一个视图名和视图内容</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> ModelAndView <span class="hljs-title">resolve</span><span class="hljs-params">(String viewName, Map&lt;String, Object&gt; model)</span> </span>&#123;<br>        <span class="hljs-comment">//视图名拼接Resource</span><br>        String errorViewName = <span class="hljs-string">&quot;error/&quot;</span> + viewName;<br>        <span class="hljs-comment">//模板可用性提供程序</span><br>        TemplateAvailabilityProvider provider = <span class="hljs-keyword">this</span>.templateAvailabilityProviders.getProvider(errorViewName, <span class="hljs-keyword">this</span>.applicationContext);<br>        <span class="hljs-comment">//模板可用，直接返回 modelAndView ; 不可用，调用 DefaultErrorViewResolver 的 resolverResource 方法</span><br>        <span class="hljs-keyword">return</span> provider != <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">new</span> ModelAndView(errorViewName, model) : <span class="hljs-keyword">this</span>.resolveResource(errorViewName, model);<br>    &#125;<br>shi<br>    <span class="hljs-comment">//resolveResource ：视图名 + 视图内容</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> ModelAndView <span class="hljs-title">resolveResource</span><span class="hljs-params">(String viewName, Map&lt;String, Object&gt; model)</span> </span>&#123;<br>    	<span class="hljs-comment">//this.staticLocations = CLASSPATH_RESOURCE_LOCATIONS</span><br>    	<span class="hljs-comment">//可以通过 spring.resources.staticLocations 进行配置。默认从静态资源文件夹下找</span><br>    	<span class="hljs-comment">//new String[]&#123;&quot;classpath:/META-INF/resources/&quot;, &quot;classpath:/resources/&quot;, &quot;classpath:/static/&quot;, &quot;classpath:/public/&quot;&#125;;</span><br>        String[] var3 = <span class="hljs-keyword">this</span>.resourceProperties.getStaticLocations();<br>        <span class="hljs-keyword">int</span> var4 = var3.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> var5 = <span class="hljs-number">0</span>; var5 &lt; var4; ++var5) &#123;<br>            String location = var3[var5];<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                Resource resource = <span class="hljs-keyword">this</span>.applicationContext.getResource(location);<br>                resource = resource.createRelative(viewName + <span class="hljs-string">&quot;.html&quot;</span>);<br>                <span class="hljs-keyword">if</span> (resource.exists()) &#123;<br>                    <span class="hljs-comment">//异常页面存在，返回 modelAndView</span><br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ModelAndView(<span class="hljs-keyword">new</span> DefaultErrorViewResolver.HtmlResourceView(resource), model);<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception var8) &#123;<br>            &#125;<br>        &#125;<br>		<span class="hljs-comment">//没有对应的异常页面，就返回null</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

</li>
</ul>
<blockquote>
<p>当以上的所有都没有时，就使用了 Spring Boot 的默认空白页面</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//errorMvcAutoConfiguration</span><br><span class="hljs-meta">@Configuration(</span><br><span class="hljs-meta">    proxyBeanMethods = false</span><br><span class="hljs-meta">)</span><br><span class="hljs-meta">@ConditionalOnProperty(</span><br><span class="hljs-meta">    prefix = &quot;server.error.whitelabel&quot;,</span><br><span class="hljs-meta">    name = &#123;&quot;enabled&quot;&#125;,</span><br><span class="hljs-meta">    matchIfMissing = true</span><br><span class="hljs-meta">)</span><br><span class="hljs-meta">@Conditional(&#123;ErrorMvcAutoConfiguration.ErrorTemplateMissingCondition.class&#125;)</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WhitelabelErrorViewConfiguration</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ErrorMvcAutoConfiguration.StaticView defaultErrorView = <span class="hljs-keyword">new</span> ErrorMvcAutoConfiguration.StaticView();<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">WhitelabelErrorViewConfiguration</span><span class="hljs-params">()</span> </span>&#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Bean(</span><br><span class="hljs-meta">        name = &#123;&quot;error&quot;&#125;</span><br><span class="hljs-meta">    )</span><br>    <span class="hljs-meta">@ConditionalOnMissingBean(</span><br><span class="hljs-meta">        name = &#123;&quot;error&quot;&#125;</span><br><span class="hljs-meta">    )</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> View <span class="hljs-title">defaultErrorView</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.defaultErrorView;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//默认的空白视图</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StaticView</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">View</span> </span>&#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> MediaType TEXT_HTML_UTF8;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Log logger;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">StaticView</span><span class="hljs-params">()</span> </span>&#123;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">render</span><span class="hljs-params">(Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>            <span class="hljs-keyword">if</span> (response.isCommitted()) &#123;<br>                String message = <span class="hljs-keyword">this</span>.getMessage(model);<br>                logger.error(message);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                response.setContentType(TEXT_HTML_UTF8.toString());<br>                StringBuilder builder = <span class="hljs-keyword">new</span> StringBuilder();<br>                Object timestamp = model.get(<span class="hljs-string">&quot;timestamp&quot;</span>);<br>                Object message = model.get(<span class="hljs-string">&quot;message&quot;</span>);<br>                Object trace = model.get(<span class="hljs-string">&quot;trace&quot;</span>);<br>                <span class="hljs-keyword">if</span> (response.getContentType() == <span class="hljs-keyword">null</span>) &#123;<br>                    response.setContentType(<span class="hljs-keyword">this</span>.getContentType());<br>                &#125;<br><br>                builder.append(<span class="hljs-string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Whitelabel Error Page&lt;/h1&gt;&quot;</span>).append(<span class="hljs-string">&quot;&lt;p&gt;This application has no explicit mapping for /error, so you are seeing this as a fallback.&lt;/p&gt;&quot;</span>).append(<span class="hljs-string">&quot;&lt;div id=&#x27;created&#x27;&gt;&quot;</span>).append(timestamp).append(<span class="hljs-string">&quot;&lt;/div&gt;&quot;</span>).append(<span class="hljs-string">&quot;&lt;div&gt;There was an unexpected error (type=&quot;</span>).append(<span class="hljs-keyword">this</span>.htmlEscape(model.get(<span class="hljs-string">&quot;error&quot;</span>))).append(<span class="hljs-string">&quot;, status=&quot;</span>).append(<span class="hljs-keyword">this</span>.htmlEscape(model.get(<span class="hljs-string">&quot;status&quot;</span>))).append(<span class="hljs-string">&quot;).&lt;/div&gt;&quot;</span>);<br>                <span class="hljs-keyword">if</span> (message != <span class="hljs-keyword">null</span>) &#123;<br>                    builder.append(<span class="hljs-string">&quot;&lt;div&gt;&quot;</span>).append(<span class="hljs-keyword">this</span>.htmlEscape(message)).append(<span class="hljs-string">&quot;&lt;/div&gt;&quot;</span>);<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (trace != <span class="hljs-keyword">null</span>) &#123;<br>                    builder.append(<span class="hljs-string">&quot;&lt;div style=&#x27;white-space:pre-wrap;&#x27;&gt;&quot;</span>).append(<span class="hljs-keyword">this</span>.htmlEscape(trace)).append(<span class="hljs-string">&quot;&lt;/div&gt;&quot;</span>);<br>                &#125;<br><br>                builder.append(<span class="hljs-string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);<br>                response.getWriter().append(builder.toString());<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">htmlEscape</span><span class="hljs-params">(Object input)</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> input != <span class="hljs-keyword">null</span> ? HtmlUtils.htmlEscape(input.toString()) : <span class="hljs-keyword">null</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">(Map&lt;String, ?&gt; model)</span> </span>&#123;<br>            Object path = model.get(<span class="hljs-string">&quot;path&quot;</span>);<br>            String message = <span class="hljs-string">&quot;Cannot render error page for request [&quot;</span> + path + <span class="hljs-string">&quot;]&quot;</span>;<br>            <span class="hljs-keyword">if</span> (model.get(<span class="hljs-string">&quot;message&quot;</span>) != <span class="hljs-keyword">null</span>) &#123;<br>                message = message + <span class="hljs-string">&quot; and exception [&quot;</span> + model.get(<span class="hljs-string">&quot;message&quot;</span>) + <span class="hljs-string">&quot;]&quot;</span>;<br>            &#125;<br><br>            message = message + <span class="hljs-string">&quot; as the response has already been committed.&quot;</span>;<br>            message = message + <span class="hljs-string">&quot; As a result, the response may have the wrong status code.&quot;</span>;<br>            <span class="hljs-keyword">return</span> message;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getContentType</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;text/html&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">static</span> &#123;<br>            TEXT_HTML_UTF8 = <span class="hljs-keyword">new</span> MediaType(<span class="hljs-string">&quot;text&quot;</span>, <span class="hljs-string">&quot;html&quot;</span>, StandardCharsets.UTF_8);<br>            logger = LogFactory.getLog(ErrorMvcAutoConfiguration.StaticView.class);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h2 id="定制错误的-json-数据"><a href="#定制错误的-json-数据" class="headerlink" title="定制错误的 json 数据"></a>定制错误的 json 数据</h2><blockquote>
<p>自定义异常处理&amp;返回定制 json 数据</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    配置异常处理器</span><br><span class="hljs-comment">    弊端：浏览器与客户端没有自适应，都返回了 json 数据</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ControllerAdvice</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyExceptionHandler</span> </span>&#123;<br><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@ExceptionHandler(value = &#123;MyException.class&#125;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">handlerException</span><span class="hljs-params">(Exception e)</span></span>&#123;<br>        HashMap&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;code&quot;</span>,<span class="hljs-string">&quot;user.noexits&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;message&quot;</span>,e.getMessage());<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>实现浏览器与客户端自适应，通过 basicErrorController 处理</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">	弊端：显示的错误信息仍是 Spring Boot 自动配置的，我们追加的数据无法处理</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@ExceptionHandler(value = &#123;MyException.class&#125;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">handlerException</span><span class="hljs-params">(Exception e, HttpServletRequest request)</span></span>&#123;<br>    <span class="hljs-comment">//添加我们的自己的错误状态码</span><br>    request.setAttribute(<span class="hljs-string">&quot;javax.servlet.error.status_code&quot;</span>,<span class="hljs-number">400</span>);<br>    HashMap&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    map.put(<span class="hljs-string">&quot;code&quot;</span>,<span class="hljs-string">&quot;user.noexits&quot;</span>);<br>    map.put(<span class="hljs-string">&quot;message&quot;</span>,e.getMessage());<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;forward:/error&quot;</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>如何展示我们自己的错误数据？</p>
</blockquote>
<ul>
<li><p>BasicErrorController 处理浏览器&amp;客户端的数据都是通过 getErrorAttributes 方法获取。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;String, Object&gt; body = <span class="hljs-keyword">this</span>.getErrorAttributes(request, <span class="hljs-keyword">this</span>.getErrorAttributeOptions(request, MediaType.ALL));<br></code></pre></td></tr></table></figure>
</li>
<li><p>getErrorAttributes 是 BasicErrorController 的父类&amp;ErrorController 接口定义的方法，返回 errorAttributes 的 getErrorAttributes 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.errorAttributes.getErrorAttributes(webRequest, options);<br></code></pre></td></tr></table></figure>

</li>
</ul>
<div class="note info"><p>通过源码分析：可以获得2种方法来实现客制化异常处理：</p>
<p>1、完全编写一个 BasicErrorController 的父类&amp;ErrorController 接口的组件。</p>
<p>2、所有展示的数据都是通过 getErrorAttributes 方法获取，编写 一个 errorAttributes 的组件</p>
</div>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span> <span class="hljs-comment">//注入组件</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyErrorAttributes</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DefaultErrorAttributes</span></span>&#123;<br>    <span class="hljs-comment">//重写 getErrorAttributes 方法</span><br>    <span class="hljs-meta">@Override</span><br>     <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">getErrorAttributes</span><span class="hljs-params">(WebRequest webRequest, ErrorAttributeOptions options)</span> </span>&#123;<br>         Map&lt;String, Object&gt; errorAttributes = <span class="hljs-keyword">super</span>.getErrorAttributes(webRequest, options);<br>         <span class="hljs-comment">//自定义异常信息</span><br>         errorAttributes.put(<span class="hljs-string">&quot;company&quot;</span>,<span class="hljs-string">&quot;atguigu&quot;</span>);<br>         <span class="hljs-comment">//获取异常处理器携带的异常数据</span><br>         Map&lt;String,Object&gt; ext = (Map&lt;String, Object&gt;) webRequest.getAttribute(<span class="hljs-string">&quot;ext&quot;</span>, <span class="hljs-number">0</span>);<br>         System.out.println(ext);<br>         errorAttributes.put(<span class="hljs-string">&quot;ext&quot;</span>,ext);<br>         <span class="hljs-keyword">return</span> errorAttributes;<br>     &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>响应是自适应的，错误信息也是可定制的。</p>
</blockquote>
<h1 id="配置嵌入式的-Servlet-容器"><a href="#配置嵌入式的-Servlet-容器" class="headerlink" title="配置嵌入式的 Servlet 容器"></a>配置嵌入式的 Servlet 容器</h1><p>Spring Boot 使用 Tomcat 作为其默认的嵌入式 Servlet 容器</p>
<p><img src="/images/post/springboot/Snipaste_10.png"></p>
<h2 id="定制-amp-修改-Servlet-容器配置"><a href="#定制-amp-修改-Servlet-容器配置" class="headerlink" title="定制&amp;修改 Servlet 容器配置"></a>定制&amp;修改 Servlet 容器配置</h2><blockquote>
<p>①编写 Spring Boot 配置文件：可配置项见 serverProperties.class</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">#修改公共的 Servlet 容器配置</span><br><span class="hljs-meta">servlet.port</span>= <span class="hljs-string">8081</span><br><span class="hljs-attr">servlet.xxx</span><br><span class="hljs-comment">#修改指定 Servlet 容器配置</span><br><span class="hljs-attr">servlet.tomcat.xxx</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>② 编写 嵌入式的Servlet容器定制器：embeddedServletContainerCustomizer</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//定制servlet容器配置</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> WebServerFactoryCustomizer <span class="hljs-title">webServerFactoryCustomizer</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> WebServerFactoryCustomizer&lt;ConfigurableWebServerFactory&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">customize</span><span class="hljs-params">(ConfigurableWebServerFactory factory)</span> </span>&#123;<br>            factory.setPort(<span class="hljs-number">8089</span>);<br>        &#125;<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="注册-Servlet-容器的三大组件"><a href="#注册-Servlet-容器的三大组件" class="headerlink" title="注册 Servlet 容器的三大组件"></a>注册 Servlet 容器的三大组件</h2><p>Spring Boot 是以 jar 包的方式启动嵌入式的 Web 应用，没有 web.xml 文件，所以相关配置就需要手动配置。</p>
<blockquote>
<p>servlet：ServletRegistrationBean</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> ServletRegistrationBean <span class="hljs-title">servletRegistrationBean</span><span class="hljs-params">()</span></span>&#123;<br>    ServletRegistrationBean&lt;Servlet&gt; servletServletRegistrationBean = <span class="hljs-keyword">new</span> ServletRegistrationBean&lt;Servlet&gt;(<span class="hljs-keyword">new</span> MyServlet(),<span class="hljs-string">&quot;/myServlet&quot;</span>);<br>    <span class="hljs-keyword">return</span> servletServletRegistrationBean;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>filter：FilterRegistrationBean</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> FilterRegistrationBean <span class="hljs-title">filterRegistrationBean</span><span class="hljs-params">()</span></span>&#123;<br>    FilterRegistrationBean&lt;Filter&gt; filterFilterRegistrationBean = <span class="hljs-keyword">new</span> FilterRegistrationBean&lt;&gt;();<br>    filterFilterRegistrationBean.setFilter(<span class="hljs-keyword">new</span> MyFilter());<br>    filterFilterRegistrationBean.setUrlPatterns(Arrays.asList(<span class="hljs-string">&quot;/myservlet&quot;</span>));<br>    <span class="hljs-keyword">return</span> filterFilterRegistrationBean;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>listener：ServletListenerRegistrationBean</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> ServletListenerRegistrationBean <span class="hljs-title">servletListenerRegistrationBean</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ServletListenerRegistrationBean&lt;MyListener&gt;(<span class="hljs-keyword">new</span> MyListener());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Spring Boot 自动配置 Spring MVC 时，帮我们自动注册了前端控制器 DispatcherServlet</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//DispatcherServletAutoConfiguration</span><br><span class="hljs-meta">@Bean(</span><br><span class="hljs-meta">    name = &#123;&quot;dispatcherServletRegistration&quot;&#125;</span><br><span class="hljs-meta">)</span><br><span class="hljs-meta">@ConditionalOnBean(</span><br><span class="hljs-meta">    value = &#123;DispatcherServlet.class&#125;,</span><br><span class="hljs-meta">    name = &#123;&quot;dispatcherServlet&quot;&#125;</span><br><span class="hljs-meta">)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> DispatcherServletRegistrationBean <span class="hljs-title">dispatcherServletRegistration</span><span class="hljs-params">(DispatcherServlet dispatcherServlet, WebMvcProperties webMvcProperties, ObjectProvider&lt;MultipartConfigElement&gt; multipartConfig)</span> </span>&#123;<br>    <span class="hljs-comment">//传入了一个 前端控制器和一个拦截路径。拦截路径是 “/”</span><br>    <span class="hljs-comment">// &quot;/*&quot; : 拦截所有请求，&quot;/&quot; : 不会拦截 jsp</span><br>    <span class="hljs-comment">//spring.mvc.servlet.path : 修改前端控制器的拦截路径</span><br>    DispatcherServletRegistrationBean registration = <span class="hljs-keyword">new</span> DispatcherServletRegistrationBean(dispatcherServlet, webMvcProperties.getServlet().getPath());<br>    registration.setName(<span class="hljs-string">&quot;dispatcherServlet&quot;</span>);<br>    registration.setLoadOnStartup(webMvcProperties.getServlet().getLoadOnStartup());<br>    multipartConfig.ifAvailable(registration::setMultipartConfig);<br>    <span class="hljs-keyword">return</span> registration;<br>&#125;<br><br><span class="hljs-comment">//webMvcProperties</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Servlet</span> </span>&#123;<br>        <span class="hljs-keyword">private</span> String path = <span class="hljs-string">&quot;/&quot;</span>;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> loadOnStartup = -<span class="hljs-number">1</span>;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Servlet</span><span class="hljs-params">()</span> </span>&#123;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPath</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.path;<br>        &#125;<br></code></pre></td></tr></table></figure>

<h2 id="Spring-Boot-支持的-Servlet-容器"><a href="#Spring-Boot-支持的-Servlet-容器" class="headerlink" title="Spring Boot 支持的 Servlet 容器"></a>Spring Boot 支持的 Servlet 容器</h2><ul>
<li><p>Tomcat：默认</p>
</li>
<li><p>Jetty：长连接</p>
</li>
<li><p>undertow：不支持 jsp，高并发性能好</p>
</li>
</ul>
<blockquote>
<p>如何切换 Servlet 容器？pom.xml 中排除 tomcat 依赖，导入 jetty/undertow 的依赖即可</p>
</blockquote>
<h2 id="嵌入式-Servlet-容器的自动配置原理"><a href="#嵌入式-Servlet-容器的自动配置原理" class="headerlink" title="嵌入式 Servlet 容器的自动配置原理"></a>嵌入式 Servlet 容器的自动配置原理</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//嵌入式 Servlet 容器自动配置类</span><br><span class="hljs-meta">@Configuration(</span><br><span class="hljs-meta">    proxyBeanMethods = false</span><br><span class="hljs-meta">)</span><br><span class="hljs-meta">@AutoConfigureOrder(-2147483648)</span><br><span class="hljs-meta">@ConditionalOnClass(&#123;ServletRequest.class&#125;)</span><br><span class="hljs-meta">@ConditionalOnWebApplication(</span><br><span class="hljs-meta">    type = Type.SERVLET</span><br><span class="hljs-meta">)</span><br><span class="hljs-meta">@EnableConfigurationProperties(&#123;ServerProperties.class&#125;)</span><br><span class="hljs-comment">//导入了 EmbeddedTomcat、EmbeddedJetty、EmbeddedUndertow：嵌入式的servlet容器，BeanPostProcessorReistrar：后置处理器注册器，让配置生效</span><br><span class="hljs-meta">@Import(&#123;ServletWebServerFactoryAutoConfiguration.BeanPostProcessorsRegistrar.class, EmbeddedTomcat.class, EmbeddedJetty.class, EmbeddedUndertow.class&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServletWebServerFactoryAutoConfiguration</span> </span>&#123;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>嵌入式</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(</span><br><span class="hljs-meta">    proxyBeanMethods = false</span><br><span class="hljs-meta">)</span><br><span class="hljs-comment">//servlet web服务器工厂配置：用来创建嵌入式的 servlet 容器</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServletWebServerFactoryConfiguration</span> </span>&#123;<br>    <br>    <span class="hljs-comment">//创建嵌入式的tomcat容器的配置</span><br>    <span class="hljs-meta">@Configuration(</span><br><span class="hljs-meta">        proxyBeanMethods = false</span><br><span class="hljs-meta">    )</span><br>    <span class="hljs-meta">@ConditionalOnClass(&#123;Servlet.class, Tomcat.class, UpgradeProtocol.class&#125;)</span><span class="hljs-comment">//判断当前引入的 web 容器依赖是不是 Tomcat</span><br>    <span class="hljs-meta">@ConditionalOnMissingBean(</span><br><span class="hljs-meta">        //判断容器中没否有用户定制的 servlet web 服务器工厂 的组件</span><br><span class="hljs-meta">        value = &#123;ServletWebServerFactory.class&#125;,</span><br><span class="hljs-meta">        search = SearchStrategy.CURRENT</span><br><span class="hljs-meta">    )</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmbeddedTomcat</span> </span>&#123;<br>        EmbeddedTomcat() &#123;<br>        &#125;<br><br>        <span class="hljs-meta">@Bean</span><br>        <span class="hljs-function">TomcatServletWebServerFactory <span class="hljs-title">tomcatServletWebServerFactory</span><span class="hljs-params">(ObjectProvider&lt;TomcatConnectorCustomizer&gt; connectorCustomizers, ObjectProvider&lt;TomcatContextCustomizer&gt; contextCustomizers, ObjectProvider&lt;TomcatProtocolHandlerCustomizer&lt;?&gt;&gt; protocolHandlerCustomizers)</span> </span>&#123;<br>            TomcatServletWebServerFactory factory = <span class="hljs-keyword">new</span> TomcatServletWebServerFactory();<br>            factory.getTomcatConnectorCustomizers().addAll((Collection)connectorCustomizers.orderedStream().collect(Collectors.toList()));<br>            factory.getTomcatContextCustomizers().addAll((Collection)contextCustomizers.orderedStream().collect(Collectors.toList()));<br>            factory.getTomcatProtocolHandlerCustomizers().addAll((Collection)protocolHandlerCustomizers.orderedStream().collect(Collectors.toList()));<br>            <span class="hljs-keyword">return</span> factory;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><p><b style="color:coral">ServletWebServerFactory：</b>servlet web 服务器工厂</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FunctionalInterface</span><span class="hljs-comment">//函数式接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ServletWebServerFactory</span> </span>&#123;<br>    <span class="hljs-comment">//创建 web 服务器</span><br>    <span class="hljs-function">WebServer <span class="hljs-title">getWebServer</span><span class="hljs-params">(ServletContextInitializer... initializers)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>ServletWebServerFactory 的继承层次：ConfigurableServletWebServerFactory —》AbstractServletWebServerFactory —》TomcatServletWebServerFactory….</p>
</blockquote>
</li>
<li><p><b style="color:coral">ConfigurableServletServerFactory：</b>可配置的 servlet web 服务器工厂</p>
</li>
</ul>
<blockquote>
<p>如何创建嵌入式的 servlet 容器?</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> WebServer <span class="hljs-title">getWebServer</span><span class="hljs-params">(ServletContextInitializer... initializers)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.disableMBeanRegistry) &#123;<br>            Registry.disableRegistry();<br>        &#125;<br><br>    	<span class="hljs-comment">//创建一个 tomcat</span><br>        Tomcat tomcat = <span class="hljs-keyword">new</span> Tomcat();<br>        File baseDir = <span class="hljs-keyword">this</span>.baseDirectory != <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">this</span>.baseDirectory : <span class="hljs-keyword">this</span>.createTempDir(<span class="hljs-string">&quot;tomcat&quot;</span>);<br>    	<span class="hljs-comment">//Tomcat 配置的基本环节</span><br>        tomcat.setBaseDir(baseDir.getAbsolutePath());<br>        Connector connector = <span class="hljs-keyword">new</span> Connector(<span class="hljs-keyword">this</span>.protocol);<br>        connector.setThrowOnFailure(<span class="hljs-keyword">true</span>);<br>        tomcat.getService().addConnector(connector);<br>        <span class="hljs-keyword">this</span>.customizeConnector(connector);<br>        tomcat.setConnector(connector);<br>        tomcat.getHost().setAutoDeploy(<span class="hljs-keyword">false</span>);<br>        <span class="hljs-keyword">this</span>.configureEngine(tomcat.getEngine());<br>        Iterator var5 = <span class="hljs-keyword">this</span>.additionalTomcatConnectors.iterator();<br><br>        <span class="hljs-keyword">while</span>(var5.hasNext()) &#123;<br>            Connector additionalConnector = (Connector)var5.next();<br>            tomcat.getService().addConnector(additionalConnector);<br>        &#125;<br><br>        <span class="hljs-keyword">this</span>.prepareContext(tomcat.getHost(), initializers);<br>    	<span class="hljs-comment">//调用 getTomcatWebServer 方法，将tomcat 传入，返回一个 web 服务器</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getTomcatWebServer(tomcat);<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">protected</span> TomcatWebServer <span class="hljs-title">getTomcatWebServer</span><span class="hljs-params">(Tomcat tomcat)</span> </span>&#123;<br>    	<span class="hljs-comment">//当端口号大于0时自动启动服务器</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TomcatWebServer(tomcat, <span class="hljs-keyword">this</span>.getPort() &gt;= <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.getShutdown());<br>    &#125;<br><br><span class="hljs-comment">//TomcatWebServer 构造器</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TomcatWebServer</span><span class="hljs-params">(Tomcat tomcat, <span class="hljs-keyword">boolean</span> autoStart, Shutdown shutdown)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.monitor = <span class="hljs-keyword">new</span> Object();<br>        <span class="hljs-keyword">this</span>.serviceConnectors = <span class="hljs-keyword">new</span> HashMap();<br>        Assert.notNull(tomcat, <span class="hljs-string">&quot;Tomcat Server must not be null&quot;</span>);<br>        <span class="hljs-keyword">this</span>.tomcat = tomcat;<br>        <span class="hljs-keyword">this</span>.autoStart = autoStart;<span class="hljs-comment">//启动服务器</span><br>        <span class="hljs-keyword">this</span>.gracefulShutdown = shutdown == Shutdown.GRACEFUL ? <span class="hljs-keyword">new</span> GracefulShutdown(tomcat) : <span class="hljs-keyword">null</span>;<span class="hljs-comment">//关闭服务器</span><br>        <span class="hljs-keyword">this</span>.initialize();<span class="hljs-comment">//初始化服务器</span><br>    &#125;<br><br><span class="hljs-comment">//tomcat 服务器初始化</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initialize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> WebServerException </span>&#123;<br>        logger.info(<span class="hljs-string">&quot;Tomcat initialized with port(s): &quot;</span> + <span class="hljs-keyword">this</span>.getPortsDescription(<span class="hljs-keyword">false</span>));<span class="hljs-comment">//日志输出</span><br>        <span class="hljs-keyword">synchronized</span>(<span class="hljs-keyword">this</span>.monitor) &#123;<span class="hljs-comment">//监控线程安全，Tomcat 是单实例多线程</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">this</span>.addInstanceIdToEngineName();<br>                Context context = <span class="hljs-keyword">this</span>.findContext();<br>                context.addLifecycleListener((event) -&gt; &#123;<br>                    <span class="hljs-keyword">if</span> (context.equals(event.getSource()) &amp;&amp; <span class="hljs-string">&quot;start&quot;</span>.equals(event.getType())) &#123;<br>                        <span class="hljs-keyword">this</span>.removeServiceConnectors();<br>                    &#125;<br><br>                &#125;);<br>                <span class="hljs-keyword">this</span>.tomcat.start();<br>                <span class="hljs-keyword">this</span>.rethrowDeferredStartupExceptions();<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    ContextBindings.bindClassLoader(context, context.getNamingToken(), <span class="hljs-keyword">this</span>.getClass().getClassLoader());<br>                &#125; <span class="hljs-keyword">catch</span> (NamingException var5) &#123;<br>                &#125;<br><br>                <span class="hljs-keyword">this</span>.startDaemonAwaitThread();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception var6) &#123;<br>                <span class="hljs-keyword">this</span>.stopSilently();<br>                <span class="hljs-keyword">this</span>.destroySilently();<br>                <span class="hljs-comment">//不能正常启动，抛出异常</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> WebServerException(<span class="hljs-string">&quot;Unable to start embedded Tomcat&quot;</span>, var6);<br>            &#125;<br><br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>对嵌入式的 servlet web 服务器的配置是如何生效的？</p>
</blockquote>
<ul>
<li><b style="color:coral">ServerProperties：</b>配置文件生效</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ServerProperties：修改配置</span><br> <span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> ServletWebServerFactoryCustomizer <span class="hljs-title">servletWebServerFactoryCustomizer</span><span class="hljs-params">(ServerProperties serverProperties)</span> </span>&#123;<br>    <span class="hljs-comment">//通过 ServletWebServerFactoryCustomizer 组件处理配置文件的配置，生效</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ServletWebServerFactoryCustomizer(serverProperties);<br>&#125;   <br><span class="hljs-comment">//或则</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@ConditionalOnClass(</span><br><span class="hljs-meta">    name = &#123;&quot;org.apache.catalina.startup.Tomcat&quot;&#125;</span><br><span class="hljs-meta">)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> TomcatServletWebServerFactoryCustomizer <span class="hljs-title">tomcatServletWebServerFactoryCustomizer</span><span class="hljs-params">(ServerProperties serverProperties)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TomcatServletWebServerFactoryCustomizer(serverProperties);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><b style="color:coral">WebServerFactoryCustomizer：</b>定制 web 服务器定制器组件</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//后置处理器定制器，作用：给容器中导入一些组件</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BeanPostProcessorsRegistrar</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ImportBeanDefinitionRegistrar</span>, <span class="hljs-title">BeanFactoryAware</span> </span>&#123;<br>        <span class="hljs-keyword">private</span> ConfigurableListableBeanFactory beanFactory;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BeanPostProcessorsRegistrar</span><span class="hljs-params">()</span> </span>&#123;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBeanFactory</span><span class="hljs-params">(BeanFactory beanFactory)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br>            <span class="hljs-keyword">if</span> (beanFactory <span class="hljs-keyword">instanceof</span> ConfigurableListableBeanFactory) &#123;<br>                <span class="hljs-keyword">this</span>.beanFactory = (ConfigurableListableBeanFactory)beanFactory;<br>            &#125;<br><br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerBeanDefinitions</span><span class="hljs-params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.beanFactory != <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">this</span>.registerSyntheticBeanIfMissing(registry, <span class="hljs-string">&quot;webServerFactoryCustomizerBeanPostProcessor&quot;</span>, WebServerFactoryCustomizerBeanPostProcessor.class);<br>                <span class="hljs-keyword">this</span>.registerSyntheticBeanIfMissing(registry, <span class="hljs-string">&quot;errorPageRegistrarBeanPostProcessor&quot;</span>, ErrorPageRegistrarBeanPostProcessor.class);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerSyntheticBeanIfMissing</span><span class="hljs-params">(BeanDefinitionRegistry registry, String name, Class&lt;?&gt; beanClass)</span> </span>&#123;<br>            <span class="hljs-keyword">if</span> (ObjectUtils.isEmpty(<span class="hljs-keyword">this</span>.beanFactory.getBeanNamesForType(beanClass, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>))) &#123;<br>                RootBeanDefinition beanDefinition = <span class="hljs-keyword">new</span> RootBeanDefinition(beanClass);<br>                beanDefinition.setSynthetic(<span class="hljs-keyword">true</span>);<br>                registry.registerBeanDefinition(name, beanDefinition);<br>            &#125;<br><br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><p><b style="color:coral">WebServerFactoryCustomizerBeanPostProcessor：</b>web 服务器工厂定制器后置处理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebServerFactoryCustomizerBeanPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">BeanPostProcessor</span>, <span class="hljs-title">BeanFactoryAware</span> </span>&#123;<br>    <span class="hljs-comment">//后置处理器的初始化之前方法，在 bean 实例属性赋值之前</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br>        <span class="hljs-comment">//存在与 web 服务器工厂相同的组件</span><br>        <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> WebServerFactory) &#123;<br>            <span class="hljs-keyword">this</span>.postProcessBeforeInitialization((WebServerFactory)bean);<br>        &#125;<br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postProcessBeforeInitialization</span><span class="hljs-params">(WebServerFactory webServerFactory)</span> </span>&#123;<br>        <span class="hljs-comment">//拿到所有的定制器，调用每一个定制器的 customizer 方法，进行属性赋值</span><br>        ((Callbacks)LambdaSafe.callbacks(WebServerFactoryCustomizer.class, <span class="hljs-keyword">this</span>.getCustomizers(), webServerFactory, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]).withLogger(WebServerFactoryCustomizerBeanPostProcessor.class)).invoke((customizer) -&gt; &#123;<br>            customizer.customize(webServerFactory);<br>        &#125;);<br>    &#125;<br>    <span class="hljs-keyword">private</span> Collection&lt;WebServerFactoryCustomizer&lt;?&gt;&gt; getCustomizers() &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.customizers == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">this</span>.customizers = <span class="hljs-keyword">new</span> ArrayList(<span class="hljs-keyword">this</span>.getWebServerFactoryCustomizerBeans());<br>            <span class="hljs-keyword">this</span>.customizers.sort(AnnotationAwareOrderComparator.INSTANCE);<br>            <span class="hljs-keyword">this</span>.customizers = Collections.unmodifiableList(<span class="hljs-keyword">this</span>.customizers);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.customizers;<br>    &#125;<br>    <span class="hljs-comment">//getWebServerFactoryCustomizerBeans</span><br>    <span class="hljs-keyword">private</span> Collection&lt;WebServerFactoryCustomizer&lt;?&gt;&gt; getWebServerFactoryCustomizerBeans() &#123;<br>        <span class="hljs-comment">//从 IOC 容器中获取 webServerFactoryCustomizer 类型的组件</span><br>        <span class="hljs-comment">//所以想定制 servlet 容器，只需向容器中添加 webServerFactoryCustomizer 类型的组件即可</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.beanFactory.getBeansOfType(WebServerFactoryCustomizer.class, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>).values();<br>    &#125;<br></code></pre></td></tr></table></figure>


</li>
</ul>
<div class="note primary"><p>①、Spring Boot 根据导入的依赖，给容器中添加相应地 ServletWebServerFactory 工厂（Tomcat~）</p>
<p>②、容器中某个组件创建对象就会启用后置处理器，只要是 WebServerFactory，就会工作</p>
<p>③、后置处理器从容器中获取所有的 定制器，并调用每一个定制器的定制方法 </p>
</div>

<h2 id="嵌入式-Servlet-容器的启动原理"><a href="#嵌入式-Servlet-容器的启动原理" class="headerlink" title="嵌入式 Servlet 容器的启动原理"></a>嵌入式 Servlet 容器的启动原理</h2><blockquote>
<p>什么时候创建 ServletWeb 服务器工厂?什么时候启动 ServletWeb 服务器?</p>
</blockquote>
<p>获取嵌入式的 ServletWeb 服务器工厂：</p>
<ul>
<li><p>Spring Boot 应用启动运行 Run 方法</p>
</li>
<li><p>refreshContext(context) Spring Boot 创建 IOC 容器对象并初始化容器。创建 IOC 容器中的每一个组件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> ConfigurableApplicationContext <span class="hljs-title">createApplicationContext</span><span class="hljs-params">()</span> </span>&#123;<br>        Class&lt;?&gt; contextClass = <span class="hljs-keyword">this</span>.applicationContextClass;<br>        <span class="hljs-keyword">if</span> (contextClass == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">switch</span>(<span class="hljs-keyword">this</span>.webApplicationType) &#123;<br>                <span class="hljs-keyword">case</span> SERVLET: <span class="hljs-comment">//普通 web 应用</span><br>                    contextClass = Class.forName(<span class="hljs-string">&quot;org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> REACTIVE: <span class="hljs-comment">//反应式 web 应用</span><br>                    contextClass = Class.forName(<span class="hljs-string">&quot;org.springframework.boot.web.reactive.context.AnnotationConfigReactiveWebServerApplicationContext&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">default</span>: <span class="hljs-comment">//默认的普通应用</span><br>                    contextClass = Class.forName(<span class="hljs-string">&quot;org.springframework.context.annotation.AnnotationConfigApplicationContext&quot;</span>);<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var3) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;Unable create a default ApplicationContext, please specify an ApplicationContextClass&quot;</span>, var3);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> (ConfigurableApplicationContext)BeanUtils.instantiateClass(contextClass);<br>    &#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>创建完，调用 applicationContext.refresh() 进行刷新。首先会调用父类的 refresh 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">refresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException, IllegalStateException </span>&#123;<br>		<span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.startupShutdownMonitor) &#123;<br>			<span class="hljs-comment">// Prepare this context for refreshing.</span><br>			prepareRefresh();<br><br>			<span class="hljs-comment">// Tell the subclass to refresh the internal bean factory.</span><br>			ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();<br><br>			<span class="hljs-comment">// Prepare the bean factory for use in this context.</span><br>			prepareBeanFactory(beanFactory);<br><br>			<span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-comment">// Allows post-processing of the bean factory in context subclasses.</span><br>				postProcessBeanFactory(beanFactory);<br><br>				<span class="hljs-comment">// Invoke factory processors registered as beans in the context.</span><br>				invokeBeanFactoryPostProcessors(beanFactory);<br><br>				<span class="hljs-comment">// Register bean processors that intercept bean creation.</span><br>				registerBeanPostProcessors(beanFactory);<br><br>				<span class="hljs-comment">// Initialize message source for this context.</span><br>				initMessageSource();<br><br>				<span class="hljs-comment">// Initialize event multicaster for this context.</span><br>				initApplicationEventMulticaster();<br><br>				<span class="hljs-comment">// Initialize other special beans in specific context subclasses.</span><br>				onRefresh();<br><br>				<span class="hljs-comment">// Check for listener beans and register them.</span><br>				registerListeners();<br><br>				<span class="hljs-comment">// Instantiate all remaining (non-lazy-init) singletons.</span><br>				finishBeanFactoryInitialization(beanFactory);<br><br>				<span class="hljs-comment">// Last step: publish corresponding event.</span><br>				finishRefresh();<br>			&#125;<br><br>			<span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>				<span class="hljs-keyword">if</span> (logger.isWarnEnabled()) &#123;<br>					logger.warn(<span class="hljs-string">&quot;Exception encountered during context initialization - &quot;</span> +<br>							<span class="hljs-string">&quot;cancelling refresh attempt: &quot;</span> + ex);<br>				&#125;<br><br>				<span class="hljs-comment">// Destroy already created singletons to avoid dangling resources.</span><br>				destroyBeans();<br><br>				<span class="hljs-comment">// Reset &#x27;active&#x27; flag.</span><br>				cancelRefresh(ex);<br><br>				<span class="hljs-comment">// Propagate exception to caller.</span><br>				<span class="hljs-keyword">throw</span> ex;<br>			&#125;<br><br>			<span class="hljs-keyword">finally</span> &#123;<br>				<span class="hljs-comment">// Reset common introspection caches in Spring&#x27;s core, since we</span><br>				<span class="hljs-comment">// might not ever need metadata for singleton beans anymore...</span><br>				resetCommonCaches();<br>			&#125;<br>		&#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>onRefresh()，web 的 IOC 容器重写了父类的 onRefresh 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onRefresh</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.onRefresh();<span class="hljs-comment">//调用父类的刷新</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">this</span>.createWebServer();<span class="hljs-comment">//创建 web 服务器</span><br>        &#125; <span class="hljs-keyword">catch</span> (Throwable var2) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ApplicationContextException(<span class="hljs-string">&quot;Unable to start web server&quot;</span>, var2);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>创建 web 服务器，先获取 web 服务器工厂</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createWebServer</span><span class="hljs-params">()</span> </span>&#123;<br>        WebServer webServer = <span class="hljs-keyword">this</span>.webServer;<br>        ServletContext servletContext = <span class="hljs-keyword">this</span>.getServletContext();<br>        <span class="hljs-keyword">if</span> (webServer == <span class="hljs-keyword">null</span> &amp;&amp; servletContext == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-comment">//获取 web 服务器工厂</span><br>            ServletWebServerFactory factory = <span class="hljs-keyword">this</span>.getWebServerFactory();<br>            <span class="hljs-comment">//通过工厂来创建 web 服务器</span><br>            <span class="hljs-keyword">this</span>.webServer = factory.getWebServer(<span class="hljs-keyword">new</span> ServletContextInitializer[]&#123;<span class="hljs-keyword">this</span>.getSelfInitializer()&#125;);<br>            <span class="hljs-keyword">this</span>.getBeanFactory().registerSingleton(<span class="hljs-string">&quot;webServerGracefulShutdown&quot;</span>, <span class="hljs-keyword">new</span> WebServerGracefulShutdownLifecycle(<span class="hljs-keyword">this</span>.webServer));<br>            <span class="hljs-keyword">this</span>.getBeanFactory().registerSingleton(<span class="hljs-string">&quot;webServerStartStop&quot;</span>, <span class="hljs-keyword">new</span> WebServerStartStopLifecycle(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.webServer));<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (servletContext != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">this</span>.getSelfInitializer().onStartup(servletContext);<br>            &#125; <span class="hljs-keyword">catch</span> (ServletException var4) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ApplicationContextException(<span class="hljs-string">&quot;Cannot initialize servlet context&quot;</span>, var4);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">this</span>.initPropertySources();<br>    &#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>从 IOC 容器中获取 ServletWebServerFactory 组件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> ServletWebServerFactory <span class="hljs-title">getWebServerFactory</span><span class="hljs-params">()</span> </span>&#123;<br>    	<span class="hljs-comment">//获取组件</span><br>       String[] beanNames = <span class="hljs-keyword">this</span>.getBeanFactory().getBeanNamesForType(ServletWebServerFactory.class);<br>       <span class="hljs-keyword">if</span> (beanNames.length == <span class="hljs-number">0</span>) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ApplicationContextException(<span class="hljs-string">&quot;Unable to start ServletWebServerApplicationContext due to missing ServletWebServerFactory bean.&quot;</span>);<br>       &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanNames.length &gt; <span class="hljs-number">1</span>) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ApplicationContextException(<span class="hljs-string">&quot;Unable to start ServletWebServerApplicationContext due to multiple ServletWebServerFactory beans : &quot;</span> + StringUtils.arrayToCommaDelimitedString(beanNames));<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>           <span class="hljs-keyword">return</span> (ServletWebServerFactory)<span class="hljs-keyword">this</span>.getBeanFactory().getBean(beanNames[<span class="hljs-number">0</span>], ServletWebServerFactory.class);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>在获取组件时，触发了后置处理器，获取所有的 ServletWebServerFactory 的定制器，并调用每一个定制器对应的定制方法。</p>
</li>
<li><p>使用容器工厂来获取 web 服务器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">this</span>.webServer = factory.getWebServer(<span class="hljs-keyword">new</span> ServletContextInitializer[]&#123;<span class="hljs-keyword">this</span>.getSelfInitializer()&#125;);<br></code></pre></td></tr></table></figure>
</li>
<li><p>嵌入式的 Servlet 容器创建对象，并启动服务器</p>
</li>
</ul>
<div class="note primary"><p>总结：</p>
<p>先启动嵌入式的 Servlet 服务器，再将 IOC 容器中没有创建的bean实例获取，最后IOC容器初始化完毕</p>
<p>IOC 容器创建时启动 Servlet 服务器。</p>
</div>

<h2 id="使用外置的-Servlet-容器"><a href="#使用外置的-Servlet-容器" class="headerlink" title="使用外置的 Servlet 容器"></a>使用外置的 Servlet 容器</h2><p>嵌入式的 Servlet 容器使用起来简单快捷，开箱即用。但是默认不支持 JSP。</p>
<blockquote>
<p>如何使 Servlet 容器支持 JSP?</p>
</blockquote>
<ul>
<li>编写相关的定制器</li>
<li>编写可支持 JSP 的 ServletWebServerFactory </li>
<li>使用外置的 Servlet 容器：应用需要打成 WAR 包</li>
</ul>
<blockquote>
<p>如何使用外置的 Servlet 容器?</p>
</blockquote>
<div class="note danger"><p>当前的 Spring Boot 项目的打包方式必须是 WAR 包</p>
</div>

<p><img src="/images/post/springboot/Snipaste_11.png"></p>
<p><img src="/images/post/springboot/Snipaste_12.png"></p>
<p>以上是使用 Spring Initializr 创建的 Spring Boot 项目，它帮我们自动配置省略了一些重要步骤：</p>
<ul>
<li><p>pom.xml 中 tomcat 的依赖 scope 要指定为 provided，当环境中有服务器，就不需要把tomcat打包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>在 Spring Boot 的主程序同级目录下创建 SpringBootServletInitializer 的子类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServletInitializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SpringBootServletInitializer</span> </span>&#123;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-function"><span class="hljs-keyword">protected</span> SpringApplicationBuilder <span class="hljs-title">configure</span><span class="hljs-params">(SpringApplicationBuilder application)</span> </span>&#123;<br>        <span class="hljs-comment">//把 Spring Boot 的主程序加载进来</span><br>		<span class="hljs-keyword">return</span> application.sources(SpringbootServerWebApplication.class);<br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="外置-Servlet-服务器启用-Spring-Boot-应用原理"><a href="#外置-Servlet-服务器启用-Spring-Boot-应用原理" class="headerlink" title="外置 Servlet 服务器启用 Spring Boot 应用原理"></a>外置 Servlet 服务器启用 Spring Boot 应用原理</h2><p>详情可参照 Servlet 3.0 规范        <a class="btn-beautify button--animated orange larger" href="/downloads/servlet-3_1-final.pdf" 
  title="Servlet 3.0 规范文档"><i class="far fa-hand-point-right fa-fw"></i><span>Servlet 3.0 规范文档</span></a></p>
<blockquote>
<p>P 8.2.4 Shared libraries / runtimes pluggability</p>
</blockquote>
<p><b style="color: mediumorchid">共享库与运行时插件的规则：</b></p>
<ul>
<li><p>服务器启动（web 应用启动），会创建当前 Web 应用里边每一个 jar 包里边的 <b style="color: fuchsia">ServletContainerInitializer 的实例</b></p>
</li>
<li><p>ServletContainerInitializer 的实现绑定在 jar 包中的 <b style="color: mediumpurple">WEB-INF/services</b> 文件夹下，有一个名为 <b style="color: crimson">javax.servlet.ServletContainerInitializer</b> 的文件，内容就是 <b style="color: fuchsia">ServletContainerInitializer 的全类名</b></p>
<p><img src="/images/post/springboot/Snipaste_13.png"></p>
</li>
<li><p>还可以使用 <b style="color: mediumvioletred">HandlesTypes 注解</b>，在应用启动的时候加载我们感兴趣的类</p>
</li>
</ul>
<p><b style="color: mediumorchid">原理具体流程：</b></p>
<ul>
<li><p>启动 Tomcat 服务器</p>
</li>
<li><p>创建 <b style="color: brown">org.springframework.web.SpringServletContainerInitializer</b> 的实例</p>
</li>
<li><p><b style="color: brown">SpringServletContainerInitializer</b> 把 <b style="color: mediumvioletred">HandlesTypes 注解</b>标注的类型的所有类传入到 onStartup 的 Set 集合中，创建该类型的所有类的实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@HandlesTypes(WebApplicationInitializer.class)</span><br><span class="hljs-comment">//传入 WebApplicationInitializer 类型的类</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringServletContainerInitializer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ServletContainerInitializer</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-comment">//放到 Set 集合中</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onStartup</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Set&lt;Class&lt;?&gt;&gt; webAppInitializerClasses, ServletContext servletContext)</span></span><br><span class="hljs-function">			<span class="hljs-keyword">throws</span> ServletException </span>&#123;<br><br>		List&lt;WebApplicationInitializer&gt; initializers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();<br>		<br>		<span class="hljs-keyword">if</span> (webAppInitializerClasses != <span class="hljs-keyword">null</span>) &#123;<br>			<span class="hljs-keyword">for</span> (Class&lt;?&gt; waiClass : webAppInitializerClasses) &#123;<br>				<span class="hljs-comment">// Be defensive: Some servlet containers provide us with invalid classes,</span><br>				<span class="hljs-comment">// no matter what @HandlesTypes says...</span><br>                <span class="hljs-comment">//对集合中的类进行判断，不是接口、抽象类，且是可分配的</span><br>				<span class="hljs-keyword">if</span> (!waiClass.isInterface() &amp;&amp; !Modifier.isAbstract(waiClass.getModifiers()) &amp;&amp;<br>						WebApplicationInitializer.class.isAssignableFrom(waiClass)) &#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>						initializers.add((WebApplicationInitializer)<br>                                         <span class="hljs-comment">//创建集合中每一个符合条件的类的实例</span><br>								ReflectionUtils.accessibleConstructor(waiClass).newInstance());<br>					&#125;<br>					<span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ServletException(<span class="hljs-string">&quot;Failed to instantiate WebApplicationInitializer class&quot;</span>, ex);<br>					&#125;<br>				&#125;<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (initializers.isEmpty()) &#123;<br>			servletContext.log(<span class="hljs-string">&quot;No Spring WebApplicationInitializer types detected on classpath&quot;</span>);<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br><br>		servletContext.log(initializers.size() + <span class="hljs-string">&quot; Spring WebApplicationInitializers detected on classpath&quot;</span>);<br>		AnnotationAwareOrderComparator.sort(initializers);<br>		<span class="hljs-keyword">for</span> (WebApplicationInitializer initializer : initializers) &#123;<br>            <span class="hljs-comment">//每一个 initializer 调用 onStartup 方法</span><br>			initializer.onStartup(servletContext);<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>每一个 <b style="color: chartreuse">WebApplicationInitializer</b> 调用自己的 onStartup 方法</p>
<p><img src="/images/post/springboot/Snipaste_14.png"></p>
<blockquote>
<p>从继承树可以发现，实际上服务器启动时，SpringBootServletInitializer 类会被创建实例，并调用自己的 onStartup 方法</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onStartup</span><span class="hljs-params">(ServletContext servletContext)</span> <span class="hljs-keyword">throws</span> ServletException </span>&#123;<br>        <span class="hljs-keyword">this</span>.logger = LogFactory.getLog(<span class="hljs-keyword">this</span>.getClass());<br>    	<span class="hljs-comment">//创建 IOC 容器</span><br>        WebApplicationContext rootApplicationContext = <span class="hljs-keyword">this</span>.createRootApplicationContext(servletContext);<br>        <span class="hljs-keyword">if</span> (rootApplicationContext != <span class="hljs-keyword">null</span>) &#123;<br>            servletContext.addListener(<span class="hljs-keyword">new</span> SpringBootServletInitializer.SpringBootContextLoaderListener(rootApplicationContext, servletContext));<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">this</span>.logger.debug(<span class="hljs-string">&quot;No ContextLoaderListener registered, as createRootApplicationContext() did not return an application context&quot;</span>);<br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p><b style="color: chartreuse">SpringBootServletInitializer</b> 调用自己的 onStartup 方法时，创建 IOC 容器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> WebApplicationContext <span class="hljs-title">createRootApplicationContext</span><span class="hljs-params">(ServletContext servletContext)</span> </span>&#123;<br>    	<span class="hljs-comment">//创建 Spring Boot 的建造器</span><br>        SpringApplicationBuilder builder = <span class="hljs-keyword">this</span>.createSpringApplicationBuilder();<br>        builder.main(<span class="hljs-keyword">this</span>.getClass());<br>        ApplicationContext parent = <span class="hljs-keyword">this</span>.getExistingRootWebApplicationContext(servletContext);<br>        <span class="hljs-keyword">if</span> (parent != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">this</span>.logger.info(<span class="hljs-string">&quot;Root context already created (using as parent).&quot;</span>);<br>            servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, (Object)<span class="hljs-keyword">null</span>);<br>            builder.initializers(<span class="hljs-keyword">new</span> ApplicationContextInitializer[]&#123;<span class="hljs-keyword">new</span> ParentContextApplicationContextInitializer(parent)&#125;);<br>        &#125;<br><br>        builder.initializers(<span class="hljs-keyword">new</span> ApplicationContextInitializer[]&#123;<span class="hljs-keyword">new</span> ServletContextApplicationContextInitializer(servletContext)&#125;);<br>        builder.contextClass(AnnotationConfigServletWebServerApplicationContext.class);<br>    	<span class="hljs-comment">//调用子类的 configure 方法，将Spring Boot 的主程序类传入</span><br>        builder = <span class="hljs-keyword">this</span>.configure(builder);<br>        builder.listeners(<span class="hljs-keyword">new</span> ApplicationListener[]&#123;<span class="hljs-keyword">new</span> SpringBootServletInitializer.WebEnvironmentPropertySourceInitializer(servletContext)&#125;);<br>    	<span class="hljs-comment">//利用 Spring 的建造器，创建 Spring Boot 应用</span><br>        SpringApplication application = builder.build();<br>        <span class="hljs-keyword">if</span> (application.getAllSources().isEmpty() &amp;&amp; MergedAnnotations.from(<span class="hljs-keyword">this</span>.getClass(), SearchStrategy.TYPE_HIERARCHY).isPresent(Configuration.class)) &#123;<br>            application.addPrimarySources(Collections.singleton(<span class="hljs-keyword">this</span>.getClass()));<br>        &#125;<br><br>        Assert.state(!application.getAllSources().isEmpty(), <span class="hljs-string">&quot;No SpringApplication sources have been defined. Either override the configure method or add an @Configuration annotation&quot;</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.registerErrorPageFilter) &#123;<br>            application.addPrimarySources(Collections.singleton(ErrorPageFilterConfiguration.class));<br>        &#125;<br><br>        application.setRegisterShutdownHook(<span class="hljs-keyword">false</span>);<br>    	<span class="hljs-comment">//启动 Spring Boot 应用，run 方法又回到了 IOC 容器启动的步骤</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.run(application);<br>    &#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>Spring Boot 应用就启动起来了</p>
</li>
</ul>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:outcome1998@gmail.com">mofang-sudo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2020/10/28/SpringBoot-%E7%9A%84%E5%AE%A2%E5%88%B6%E5%8C%96/">http://example.com/2020/10/28/SpringBoot-%E7%9A%84%E5%AE%A2%E5%88%B6%E5%8C%96/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">墨坊のBlog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringBoot/">SpringBoot</a></div><div class="post_share"><div class="social-share" data-image="/images/post/preview22.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/10/29/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84-Docker-%E5%AD%A6%E4%B9%A0/"><img class="prev-cover" src="/images/post/preview23.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">从零开始的 Docker 学习</div></div></a></div><div class="next-post pull-right"><a href="/2020/10/26/SpringBoot-%E5%BF%AB%E9%80%9FCRUD/"><img class="next-cover" src="/images/post/preview21.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">SpringBoot 快速CRUD</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/10/23/SpringBoot-与日志/" title="SpringBoot 与日志"><img class="cover" src="/images/post/preview18.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-23</div><div class="title">SpringBoot 与日志</div></div></a></div><div><a href="/2020/11/02/SpringBoot-启动配置原理/" title="SpringBoot 启动配置原理"><img class="cover" src="/images/post/preview25.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-02</div><div class="title">SpringBoot 启动配置原理</div></div></a></div><div><a href="/2020/10/26/SpringBoot-快速CRUD/" title="SpringBoot 快速CRUD"><img class="cover" src="/images/post/preview21.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-26</div><div class="title">SpringBoot 快速CRUD</div></div></a></div><div><a href="/2020/10/30/SpringBoot-与数据访问/" title="SpringBoot 与数据访问"><img class="cover" src="/images/post/preview24.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-30</div><div class="title">SpringBoot 与数据访问</div></div></a></div><div><a href="/2020/10/21/SpringBoot-学习-初相识/" title="Spring Boot 入门"><img class="cover" src="/images/post/preview17.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-21</div><div class="title">Spring Boot 入门</div></div></a></div><div><a href="/2020/10/24/SpringBoot-自动配置原理/" title="SpringBoot 自动配置原理"><img class="cover" src="/images/post/preview19.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-24</div><div class="title">SpringBoot 自动配置原理</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="lv-container" data-id="city" data-uid="MTAyMC81MTU3Ni8yODA1Nw=="></div></div></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By mofang-sudo</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://mofang-sudo.github.io/">blog</a>!</div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    $.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js', function () {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      true && mermaid.init()
    })
  }
}</script><script>function loadLivere () {
  if (typeof LivereTower === 'object') {
    window.LivereTower.init()
  }
  else {
    (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
    })(document, 'script');
  }
}

if ('Livere' === 'Livere' || !false) {
  if (false) btf.loadComment(document.getElementById('lv-container'), loadLivere)
  else loadLivere()
}
else {
  function loadOtherComment () {
    loadLivere()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script defer="defer" id="ribbon_piao" mobile="true" src="/js/third-party/piao.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  'meta[name=description]',
  '#config_change',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (true) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  $('script[data-pjax]').each(function () {
    $(this).parent().append($(this).remove())
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  if (typeof gtag === 'function') {
    gtag('config', '', {'page_path': window.location.pathname});
  }

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})


document.addEventListener('pjax:send', function () {
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  $(window).off('scroll')

  //reset readmode
  $('body').hasClass('read-mode') && $('body').removeClass('read-mode')

})</script></div></body></html>